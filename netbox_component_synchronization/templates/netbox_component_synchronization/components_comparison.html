{% extends 'base/layout.html' %}

{% block title %}{{ device }} - {{ component_type }} comparison{% endblock %}
{% block header %}
    <nav class="breadcrumb-container px-3" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dcim:device_list' %}">Devices</a></li>
            <li class="breadcrumb-item"><a href="{% url 'dcim:device_list' %}?site={{ device.site.slug }}">{{ device.site }}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'dcim:device' pk=device.id %}">{{ device }}</a></li>
        </ol>
    </nav>
    {{ block.super }}
{% endblock %}

{% block content %}
<style>
    .caption-red {
        caption-side: top;
        color: red;
    }

    .caption-green {
        caption-side: top;
        color: green;
    }
    
    .sync-status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .sync-status-in-sync { background-color: #28a745; }
    .sync-status-name-mismatch { background-color: #ffc107; }
    .sync-status-missing-from-device { background-color: #dc3545; }
    .sync-status-missing-from-template { background-color: #17a2b8; }
    
    .bulk-actions {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .sync-stats {
        background-color: #e9ecef;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .sync-stats .stat-item {
        display: inline-block;
        margin-right: 1rem;
    }
</style>
<script>
function toggle(event) {
  event = event || window.event;
  var src = event.target || event.srcElement || event;
  checkboxes = document.getElementsByName(src.id);
  for(var checkbox of checkboxes) checkbox.checked = src.checked;
}

function uncheck(event) {
  event = event || window.event;
  var src = event.target || event.srcElement || event;
  if (src.checked == false) {
    document.getElementById(src.name).checked = false;
  }
}

function toggleSyncStatus() {
  var showSyncStatus = document.getElementById('sync-status-toggle').checked;
  var url = new URL(window.location);
  url.searchParams.set('show_sync_status', showSyncStatus);
  window.location.href = url;
}

function confirmBulkAction(actionName) {
  return confirm('Are you sure you want to ' + actionName + '? This action cannot be undone.');
}
</script>

<!-- Sync Status Toggle -->
<div class="mb-3">
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="sync-status-toggle" 
               {% if show_sync_status %}checked{% endif %} onchange="toggleSyncStatus()">
        <label class="form-check-label" for="sync-status-toggle">
            Show sync status indicators
        </label>
    </div>
</div>

<!-- Sync Statistics -->
{% if show_sync_status %}
<div class="sync-stats">
    <h6>Sync Status Summary:</h6>
    <div class="stat-item">
        <span class="sync-status-indicator sync-status-in-sync"></span>
        In Sync: {{ sync_stats.in_sync }}
    </div>
    <div class="stat-item">
        <span class="sync-status-indicator sync-status-name-mismatch"></span>
        Name Mismatch: {{ sync_stats.name_mismatch }}
    </div>
    <div class="stat-item">
        <span class="sync-status-indicator sync-status-missing-from-device"></span>
        Missing from Device: {{ sync_stats.missing_from_device }}
    </div>
    <div class="stat-item">
        <span class="sync-status-indicator sync-status-missing-from-template"></span>
        Extra in Device: {{ sync_stats.missing_from_template }}
    </div>
</div>
{% endif %}

<form method="post">
    {% csrf_token %}
    
    <!-- Bulk Actions -->
    {% if permitted_actions %}
    <div class="bulk-actions">
        <h6>Bulk Actions:</h6>
        <div class="btn-group" role="group" aria-label="Bulk sync actions">
            {% if 'bulk_add_missing' in permitted_actions %}
            <button type="submit" name="bulk_add_missing" value="true" class="btn btn-success btn-sm"
                    onclick="return confirmBulkAction('add all missing components')">
                <i class="mdi mdi-plus"></i> Add Missing Components
            </button>
            {% endif %}
            {% if 'bulk_repair_out_of_sync' in permitted_actions %}
            <button type="submit" name="bulk_repair_out_of_sync" value="true" class="btn btn-warning btn-sm"
                    onclick="return confirmBulkAction('repair out of sync components')">
                <i class="mdi mdi-wrench"></i> Repair Out of Sync
            </button>
            {% endif %}
            {% if 'bulk_remove_out_of_sync' in permitted_actions %}
            <button type="submit" name="bulk_remove_out_of_sync" value="true" class="btn btn-danger btn-sm"
                    onclick="return confirmBulkAction('remove out of sync components')">
                <i class="mdi mdi-delete"></i> Remove Out of Sync
            </button>
            {% endif %}
            {% if 'bulk_sync_all' in permitted_actions %}
            <button type="submit" name="bulk_sync_all" value="true" class="btn btn-primary btn-sm"
                    onclick="return confirmBulkAction('sync all components')">
                <i class="mdi mdi-sync"></i> Sync All Components
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="table-responsive-xl">
        <table class="table table-hover table-bordered">
            {% if templates_count == components_count %}
            <caption class="caption-green">
                The device and device type have the same number of {{ component_type }}.
            </caption>
            {% else %}
            <caption class="caption-red">
                The device and device type have different number of {{ component_type|lower }}.<br>
                Device: {{ components_count }}<br>
                Device type: {{ templates_count }}
            </caption>
            {% endif %}
            <thead>
            <tr>
                <th scope="col" colspan="2">Device type</th>
                <th scope="col">Actions</th>
                <th scope="col" colspan="2">Device</th>
                <th scope="col" colspan="2">Actions</th>
            </tr>
            <tr>
                <th scope="col">Name</th>
                <th scope="col">Attributes</th>
                <th scope="col">
                    <label>
                        <input type="checkbox" id="add_to_device" onclick="toggle(this)">
                        Add to the device
                    </label>
                </th>
                <th scope="col">Name</th>
                <th scope="col">Attributes</th>
                <th scope="col">
                    <label>
                        <input type="checkbox" id="remove_from_device" onclick="toggle(this)">
                        Remove
                    </label>
                </th>
                <th scope="col">
                    <label>
                        <input type="checkbox" id="fix_name" onclick="toggle(this)">
                        Fix the name
                    </label>
                </th>
            </tr>
            </thead>
            <tbody>
            {% for component_template, component, sync_status in comparison_items %}
                <tr>
                {% if component_template %}
                    <th scope="row" {% if not component %}class="table-danger"{% endif %}>
                        {% if show_sync_status %}
                            <span class="sync-status-indicator sync-status-{{ sync_status }}"></span>
                        {% endif %}
                        {% if component and component_template.name != component.name %}
                        <span style="background-color: #eab2b2">{{ component_template.name }}</span>
                        {% else %}
                        {{ component_template.name }}
                        {% endif %}
                    </th>
                    <td style="white-space:pre" {% if not component %}class="table-danger"{% endif %}>{{ component_template }}</td>
                    <td {% if not component %}class="table-danger"{% endif %}>
                        {% if not component %}
                        <label>
                            <input type="checkbox" name="add_to_device" value="{{ component_template.id }}" onclick="uncheck(this)">
                            Add to device
                        </label>
                        {% endif %}
                    </td>
                {% else %}
                    <th scope="row">&nbsp;</th>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                {% endif %}

                {% if component %}
                    <th scope="row" {% if not component_template %}class="table-success"{% endif %}>
                        {% if show_sync_status %}
                            <span class="sync-status-indicator sync-status-{{ sync_status }}"></span>
                        {% endif %}
                        {% if component_template and component_template.name != component.name %}
                        <span style="background-color: #cde8c2">{{ component.name }}</span>
                        {% else %}
                        {{ component.name }}
                        {% endif %}
                    </th>
                    <td style="white-space:pre" {% if not component_template %}class="table-success"{% endif %}>{{ component }}</td>
                    <td {% if not component_template %}class="table-success"{% endif %}>
                        {% if not component_template %}
                        <label>
                            <input type="checkbox" name="remove_from_device" value="{{ component.id }}" onclick="uncheck(this)">
                            Remove
                        </label>
                        {% endif %}
                    </td>
                    <td {% if not component_template %}class="table-success"{% endif %}>
                        {% if component_template and component_template.name != component.name %}
                        <label>
                            <input type="checkbox" name="fix_name" value="{{ component.id }}" onclick="uncheck(this)">
                            Fix name
                        </label>
                        {% endif %}
                    </td>
                {% else %}
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                {% endif %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div>
        <input type="submit" value="Apply" class="btn btn-primary" style="float: right;">
    </div>
</form>

{% endblock %}